<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciando Portal ILAR...</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; overflow: hidden;
        }
        .loading-container {text-align: center; max-width: 500px; padding: 2rem;}
        .logo {font-size: 5rem; margin-bottom: 2rem; animation: pulse 2s infinite;}
        .title {font-size: 2.5rem; font-weight: 300; margin-bottom: 1rem; opacity: 0.95;}
        .subtitle {font-size: 1.2rem; margin-bottom: 3rem; opacity: 0.8; font-weight: 300;}
        .loading-progress {
            width: 100%; height: 6px; background: rgba(255,255,255,0.2);
            border-radius: 3px; overflow: hidden; margin-bottom: 2rem; position: relative;
        }
        .loading-bar {
            height: 100%; background: linear-gradient(90deg, rgba(255,255,255,0.8), rgba(255,255,255,1), rgba(255,255,255,0.8));
            border-radius: 3px; animation: loading 2s ease-in-out infinite;
        }
        .status-text {font-size: 1.1rem; margin-bottom: 1rem; min-height: 1.5rem; opacity: 0.9; transition: all 0.3s ease;}
        .dots {display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;}
        .dot {
            width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.6);
            animation: dotPulse 1.4s ease-in-out infinite both;
        }
        .dot:nth-child(1) {animation-delay: -0.32s;}
        .dot:nth-child(2) {animation-delay: -0.16s;}
        .dot:nth-child(3) {animation-delay: 0s;}
        .success-message {
            background: rgba(46, 204, 113, 0.9); padding: 1.5rem; border-radius: 10px;
            margin-top: 2rem; display: none; border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .error-message {
            background: rgba(231, 76, 60, 0.9); padding: 1.5rem; border-radius: 10px;
            margin-top: 2rem; display: none; border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .btn {
            background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3);
            padding: 0.75rem 2rem; border-radius: 25px; cursor: pointer; font-size: 1rem;
            margin-top: 1rem; transition: all 0.3s ease; text-decoration: none; display: inline-block;
        }
        .btn:hover {background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); color: white;}
        @keyframes pulse {0%, 100% {transform: scale(1); opacity: 1;} 50% {transform: scale(1.05); opacity: 0.8;}}
        @keyframes loading {0% {width: 0%; transform: translateX(-100%);} 50% {width: 100%; transform: translateX(0%);} 100% {width: 0%; transform: translateX(100%);}}
        @keyframes dotPulse {0%, 80%, 100% {transform: scale(0.8); opacity: 0.5;} 40% {transform: scale(1); opacity: 1;}}
        .success-animation {animation: successBounce 0.6s ease-out;}
        @keyframes successBounce {0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);}}
        .fade-out {animation: fadeOut 0.5s ease-out forwards;}
        @keyframes fadeOut {from {opacity: 1;} to {opacity: 0;}}
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="logo" id="logo"><i class="fas fa-dna"></i></div>
        <h1 class="title">Portal ILAR</h1>
        <p class="subtitle">Iniciando sistema...</p>
        <div class="loading-progress"><div class="loading-bar"></div></div>
        <div class="status-text" id="statusText">Cargando servidor...</div>
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        
        <div class="success-message" id="successMessage">
            <h3><i class="fas fa-check-circle"></i> ¡Servidor listo!</h3>
            <p>El Portal ILAR se ha iniciado correctamente.</p>
            <a href="/login.html" class="btn">
                <i class="fas fa-sign-in-alt"></i> Ir al Login
            </a>
        </div>
        
        <div class="error-message" id="errorMessage">
            <h3><i class="fas fa-exclamation-triangle"></i> Problema detectado</h3>
            <p>El servidor está tardando más de lo esperado en iniciar.</p>
            <button class="btn" onclick="location.reload()">
                <i class="fas fa-redo"></i> Reintentar
            </button>
            <a href="/login.html" class="btn" style="margin-left: 0.5rem;">
                <i class="fas fa-sign-in-alt"></i> Ir al Login
            </a>
        </div>
    </div>
    <script>
        let attemptCount = 0;
        let maxAttempts = 15;
        let checkInterval;
        
        const statusMessages = [
            "Cargando servidor...",
            "Iniciando FastAPI...",
            "Cargando datos de moléculas...",
            "Configurando APIs...",
            "Preparando dashboards...",
            "Finalizando configuración...",
            "¡Casi listo!"
        ];

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        function showSuccess() {
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('logo').classList.add('success-animation');
            updateStatus('¡Servidor iniciado correctamente!');
        }

        function showError() {
            document.getElementById('errorMessage').style.display = 'block';
            updateStatus('Error de conexión');
        }

        async function checkServerStatus() {
            try {
                attemptCount++;
                
                // Actualizar mensaje según progreso
                const messageIndex = Math.min(Math.floor((attemptCount - 1) / 2), statusMessages.length - 1);
                updateStatus(statusMessages[messageIndex]);

                // Intentar conectar con FastAPI
                const response = await fetch('/health', { 
                    method: 'GET',
                    cache: 'no-cache',
                    timeout: 5000
                });
                
                if (response.ok) {
                    clearInterval(checkInterval);
                    showSuccess();
                    
                    // Redirección automática después de 3 segundos
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 3000);
                    return;
                }
            } catch (error) {
                console.log(`Intento ${attemptCount}: Esperando servidor...`);
            }

            // Si llegamos al máximo de intentos
            if (attemptCount >= maxAttempts) {
                clearInterval(checkInterval);
                showError();
                return;
            }
        }

        // Iniciar verificación cuando cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página de carga iniciada');
            
            // Esperar 3 segundos antes de empezar a verificar
            // (para dar tiempo a FastAPI a iniciarse)
            setTimeout(() => {
                updateStatus('Verificando servidor...');
                checkServerStatus();
                checkInterval = setInterval(checkServerStatus, 2000);
            }, 3000);
        });
    </script>
</body>
</html>